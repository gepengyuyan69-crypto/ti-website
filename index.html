<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title data-i18n="title">Ti --- å»ä¸­å¿ƒåŒ–ä»£å¸</title>

<!-- å­—ä½“ -->
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Inter:wght@300;400;600&display=swap" rel="stylesheet">

<style>
  :root{
    --bg:#06060a;
    --card: rgba(255,255,255,0.04);
    --glass: rgba(255,255,255,0.03);
    --accent:#6ef0ff;
    --accent2:#ffcc00;
    --danger:#ff5c7c;
    --neon: 0 0 18px rgba(110,240,255,0.12), 0 0 36px rgba(110,240,255,0.06);
  }
  *{box-sizing:border-box}
  html,body{height:100%; margin:0; background: radial-gradient(ellipse at 10% 10%, rgba(14,20,30,0.6), transparent 10%), linear-gradient(180deg,#05060a 0%, #0b0f14 100%); font-family: Inter, Arial, sans-serif; color:#e8f3ff; -webkit-font-smoothing:antialiased;}
  .app {
    min-height:100vh;
    display:grid;
    grid-template-rows: 72px 1fr;
    gap:16px;
    padding:18px;
  }
  /* Top nav */
  header {
    display:flex; align-items:center; justify-content:space-between;
    gap:12px;
  }
  .brand {
    display:flex; align-items:center; gap:12px;
  }
  .logo {
    width:56px; height:56px; border-radius:12px; display:flex; align-items:center; justify-content:center;
    background: linear-gradient(135deg,#04102233, #07203344);
    box-shadow: var(--neon);
    border: 1px solid rgba(110,240,255,0.08);
    font-family: 'Orbitron', monospace; color:var(--accent); font-weight:700;
  }
  h1{margin:0;font-family:Orbitron, monospace;font-size:18px; color:var(--accent2); text-shadow:0 0 8px rgba(255,204,0,0.14)}
  .nav-actions { display:flex; gap:10px; align-items:center; }
  .btn {
    background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    border:1px solid rgba(255,255,255,0.04);
    padding:8px 12px; border-radius:10px; color:var(--accent2); cursor:pointer;
    transition: transform .15s ease, box-shadow .15s;
    box-shadow: 0 6px 18px rgba(0,0,0,0.6);
  }
  .btn:hover{ transform:translateY(-3px); box-shadow: 0 20px 40px rgba(0,0,0,0.6); }
  .glow { box-shadow: 0 0 16px rgba(110,240,255,0.18), 0 8px 30px rgba(12,20,30,0.6); border-color: rgba(110,240,255,0.18); color:var(--accent); }

  /* layout main */
  .main {
    display:grid;
    grid-template-columns: 360px 1fr 380px;
    gap:18px;
    align-items:start;
  }
  /* å·¦ä¾§å¡ç‰‡ */
  .card {
    background: var(--card);
    border-radius:14px; padding:16px; border:1px solid rgba(255,255,255,0.03);
    box-shadow: 0 6px 40px rgba(0,0,0,0.6);
    backdrop-filter: blur(6px);
  }
  .token-header { display:flex; align-items:center; gap:12px; }
  .token-avatar { width:64px; height:64px; border-radius:14px; display:flex; align-items:center; justify-content:center; background:linear-gradient(135deg,#0b7cff11,#ffcc0011); border:1px solid rgba(255,255,255,0.03); font-size:28px; color:var(--accent2);}
  .small { font-size:12px; color:#a7c4d6; }
  .price-big { font-family:Orbitron, monospace; font-size:20px; color:var(--accent); text-shadow:0 0 10px rgba(110,240,255,0.06); }
  .muted { color:#9fb4cc; font-size:13px; }

  /* ä¸­é—´æ“ä½œåŒº */
  .panel {
    background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    border-radius:14px; padding:18px; border:1px solid rgba(255,255,255,0.03);
    box-shadow: 0 8px 50px rgba(0,0,0,0.6);
  }
  .panel h2 { margin-top:0; font-family:Orbitron; color:var(--accent2); font-size:16px; }
  .row { display:flex; gap:10px; align-items:center; margin:10px 0; flex-wrap:wrap; }
  input[type="number"], input[type="text"] {
    background: rgba(255,255,255,0.02); border:1px solid rgba(255,255,255,0.03);
    color: #dff6ff; padding:10px; border-radius:8px; outline:none; min-width:160px;
  }
  .action-btn {
    background: linear-gradient(90deg, rgba(110,240,255,0.08), rgba(255,204,0,0.04));
    border: 1px solid rgba(110,240,255,0.12);
    color: #002; padding:10px 14px; border-radius:12px; font-weight:700; cursor:pointer;
    box-shadow: 0 8px 30px rgba(110,240,255,0.04); transition: transform .12s ease;
  }
  .action-btn:hover{ transform: translateY(-4px) scale(1.02); box-shadow: 0 18px 40px rgba(110,240,255,0.06); }
  .action-danger{ background: linear-gradient(90deg, rgba(255,92,124,0.12), rgba(255,204,0,0.02)); border-color: rgba(255,92,124,0.18); color:var(--danger); }

  .info-line { display:flex; justify-content:space-between; padding:8px 10px; border-radius:8px; background: rgba(0,0,0,0.25); margin-top:8px; }
  .tx-link { color: var(--accent); font-family: monospace; text-decoration:none; }

  /* å³ä¾§ */
  .side-list { display:flex; flex-direction:column; gap:12px; }
  .mini { font-size:13px; color:#9fb4cc; }

  /* mascot dialog */
  #mascot { position: fixed; bottom:28px; right:28px; width:76px; height:76px; border-radius:20px; display:flex; align-items:center; justify-content:center; font-size:34px; background:linear-gradient(135deg,#04102266,#07203366); border:1px solid rgba(255,255,255,0.04); cursor:pointer; box-shadow: 0 10px 30px rgba(0,0,0,0.6); z-index:999; transition: transform .12s; }
  #mascot:hover { transform: translateY(-6px) scale(1.05); }
  .speech {
    position: fixed; bottom:120px; right:120px; background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    padding:12px 14px; border-radius:12px; border:1px solid rgba(255,255,255,0.04); max-width:280px; box-shadow: 0 12px 40px rgba(0,0,0,0.6); display:none; z-index:999;
  }
  .speech .close { font-size:12px; color:#9fb4cc; cursor:pointer; float:right; margin-left:8px; }

  /* responsive */
  @media (max-width:1100px){
    .main { grid-template-columns: 1fr; padding:0 8px; }
    #mascot { right:12px; bottom:12px; }
    .speech { right:12px; bottom:92px; left:12px; max-width: none; }
  }

  /* little neon borders */
  .neon-border { border: 1px solid rgba(110,240,255,0.06); box-shadow: 0 0 20px rgba(110,240,255,0.06); }
  .tiny { font-size:12px; color:#9fb4cc; }
</style>
</head>
<body>
<div class="app">
  <header>
    <div class="brand">
      <div class="logo">Ti</div>
      <div>
        <h1 data-i18n="title">Ti --- å»ä¸­å¿ƒåŒ–ä»£å¸</h1>
        <div class="small tiny">BSC â€¢ PancakeSwap â€¢ å¤šé’±åŒ… â€¢ å¤šè¯­è¨€</div>
      </div>
    </div>

    <div class="nav-actions">
      <button class="btn glow" onclick="document.getElementById('swapSection').scrollIntoView({behavior:'smooth'})">äº¤æ˜“ Ti</button>
      <button class="btn" onclick="document.getElementById('otherSection').scrollIntoView({behavior:'smooth'})">æŸ¥è¯¢ä»£å¸</button>
      <button id="btn-connect" class="btn" onclick="connectWallet()"><svg width="18" height="18" viewBox="0 0 24 24" style="vertical-align:middle;margin-right:6px"><path fill="currentColor" d="M12 12c2.21 0 4-1.79 4-4S14.21 4 12 4 8 5.79 8 8s1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg><span data-i18n="connectWallet">è¿æ¥é’±åŒ…</span></button>
      <button id="langBtn" class="btn" onclick="toggleLanguage()">ä¸­æ–‡</button>
    </div>
  </header>

  <main class="main" role="main">
    <!-- å·¦ column: token info + price -->
    <section class="card neon-border">
      <div class="token-header">
        <div class="token-avatar">Ti</div>
        <div>
          <div id="tokenName" style="font-weight:700;font-size:16px">Ti</div>
          <div class="muted" id="tokenSymbol">â€”</div>
        </div>
      </div>

      <div style="margin-top:12px">
        <div class="small">å®æ—¶ä»·æ ¼ (æ¥è‡ª DexScreener)</div>
        <div style="display:flex;align-items:center;justify-content:space-between;margin-top:8px">
          <div>
            <div class="price-big" id="tokenPrice">â€” BNB</div>
            <div class="tiny">â‰ˆ <span id="tokenPriceUSD">â€”</span> USD</div>
          </div>
          <div style="text-align:right">
            <div class="small">æµåŠ¨æ€§/å¯¹</div>
            <div class="muted tiny" id="poolInfo">â€”</div>
          </div>
        </div>
      </div>

      <hr style="border:none;border-top:1px solid rgba(255,255,255,0.03);margin:12px 0" />

      <div>
        <div class="small">ä»£å¸æ€»é‡</div>
        <div id="tokenSupply" style="font-weight:600;margin-top:6px">â€”</div>
      </div>

    </section>

    <!-- ä¸­ column: æ“ä½œåŒº -->
    <section class="panel" id="swapPanel">
      <h2 data-i18n="swapTi">äº¤æ¢ Ti ä»£å¸</h2>

      <div id="swapSection">
        <div class="row">
          <label class="tiny">è¾“å…¥ Ti æ•°é‡</label>
          <input id="tiAmount" type="number" min="0" step="any" placeholder="ä¾‹å¦‚ 1000" />
          <button class="action-btn" onclick="calculateTiSwap()">è®¡ç®—</button>
        </div>

        <div id="tiCalculationResult" class="info-line">
          <div>éœ€è¦æ”¯ä»˜</div>
          <div id="tiCalcValue">â€” BNB</div>
        </div>

        <div class="row" style="margin-top:12px">
          <button id="btnBuyTi" class="action-btn glow" onclick="confirmBuyTi()">ç«‹åˆ»è´­ä¹°</button>
          <button id="btnSellTi" class="action-btn action-danger" onclick="confirmSellTi()">å‡ºå”® Ti</button>
          <div style="margin-left:auto" class="tiny muted">Gas ç”±é’±åŒ…ä¼°ç®—ï¼Œäº¤æ˜“åœ¨é“¾ä¸Šæ‰§è¡Œ</div>
        </div>

        <div style="margin-top:12px" class="tiny muted">äº¤æ˜“çŠ¶æ€ï¼š<span id="tradeStatus">ç©ºé—²</span></div>
        <div id="tradeTx" style="margin-top:8px"></div>
      </div>

      <hr style="margin:14px 0;border:none;border-top:1px solid rgba(255,255,255,0.04)" />

      <h3 style="font-family:Orbitron;font-size:13px;color:var(--accent);margin-top:8px">ä»£å¸æŸ¥è¯¢ & è´­ä¹°</h3>
      <div id="otherSection">
        <div class="row">
          <input id="otherTokenAddress" type="text" placeholder="ä»£å¸åˆçº¦åœ°å€ (ä¾‹å¦‚ 0x...)" />
          <input id="otherAmount" type="number" min="0" step="any" placeholder="è´­ä¹°æ•°é‡ (token å•ä½)" />
          <button class="action-btn" onclick="calculateOtherSwap()">è®¡ç®—</button>
        </div>

        <div id="otherCalculationResult" class="info-line">
          <div>éœ€æ”¯ä»˜</div><div id="otherCalcValue">â€” BNB</div>
        </div>

        <div class="row">
          <button class="action-btn glow" onclick="confirmBuyOther()">è´­ä¹°ä»£å¸</button>
        </div>
      </div>
    </section>

    <!-- å³ column: é’±åŒ…è¯¦æƒ… & å†å² -->
    <aside>
      <div class="card neon-border">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <div class="tiny">å·²è¿æ¥åœ°å€</div>
            <div id="wallet-address" style="font-family:monospace;word-break:break-all">æœªè¿æ¥</div>
          </div>
          <div style="text-align:right">
            <button class="btn" onclick="refreshBalances()">åˆ·æ–°</button>
          </div>
        </div>

        <div style="margin-top:12px">
          <div class="small">ä½™é¢</div>
          <div style="display:flex;justify-content:space-between;margin-top:8px">
            <div><div class="muted tiny">BNB</div><div id="bnbBalance">â€”</div></div>
            <div><div class="muted tiny">Ti</div><div id="tiBalance">â€”</div></div>
          </div>
        </div>
      </div>

      <div class="card neon-border" style="margin-top:12px">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div><div class="small">é“¾ä¸Šäº¤æ˜“ (æœ€è¿‘)</div></div>
          <div><button class="btn" onclick="fetchTxHistory()">åˆ·æ–°</button></div>
        </div>
        <div id="txList" style="margin-top:10px; font-size:13px; line-height:1.4"></div>
      </div>

      <div class="card" style="margin-top:12px">
        <div class="small">æç¤º</div>
        <ul style="padding-left:18px; margin-top:8px">
          <li class="mini">è¯·ç¡®ä¿é’±åŒ…è¿æ¥åˆ° BSC ä¸»ç½‘ (ChainId 56)</li>
          <li class="mini">è´­ä¹°æ—¶ä¼šå¼¹å‡ºé’±åŒ…ç¡®è®¤çª—å£</li>
          <li class="mini">äº¤æ˜“ä¼šåœ¨ PancakeSwap ä¸Šæ‰§è¡Œï¼ŒåŠ¡å¿…æ³¨æ„æ»‘ç‚¹</li>
        </ul>
      </div>
    </aside>
  </main>
</div>

<!-- æœºå™¨äººå‰ç¥¥ç‰©å’Œæ°”æ³¡ -->
<div id="mascot" title="ç‚¹æˆ‘æˆ‘ä¼šè¯´è¯">ğŸ¤–</div>
<div id="mascotSpeech" class="speech">
  <span class="close" onclick="hideSpeech()">âœ•</span>
  <div id="speechText">å—¨ï¼Œæˆ‘æ˜¯ Ti å°åŠ©æ‰‹ï¼</div>
</div>

<!-- scripts -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/particlesjs/2.2.3/particles.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/web3modal@1.9.12/dist/index.js"></script>
<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
<script src="https://unpkg.com/@walletconnect/web3-provider@1.7.8/dist/umd/index.min.js"></script>

<script>
/* ========== å¸¸é‡ ========== */
const TI_TOKEN_ADDRESS = "0x8b5be89c0f4eabbe51fd13cf21824b65b79527f3";
const WBNB_ADDRESS = "0xbb4CdB9Cbd36B01bD1cBaEBF2De08d9173bc095c";
const PANCAKE_ROUTER_ADDRESS = "0x10ED43C718714eb63d5aA57B78B54704E256024E";

/* æ–‡æœ¬ å›½é™…åŒ–ï¼ˆç®€/è‹±ï¼‰*/
const texts = {
  zh: { title:"Ti --- å»ä¸­å¿ƒåŒ–ä»£å¸", connectWallet:"è¿æ¥é’±åŒ…", switchLanguage:"EN", /* ...çŸ­åŒ– */ },
  en: { title:"Ti --- Decentralized Token", connectWallet:"Connect Wallet", switchLanguage:"ä¸­" }
};
let lang = 'zh';

/* web3 ç›¸å…³ */
let provider, signer, web3Modal, tiContract, routerContract;

/* UI init */
window.onload = () => {
  Particles.init({ selector: '.background', color:'#0cf', connectParticles:true, maxParticles:80, sizeVariations:3 });
  initWeb3Modal();
  bindUI();
  refreshTokenInfo();
  initMascot();
};

/* åˆå§‹åŒ– Web3Modal */
function initWeb3Modal(){
  const providerOptions = {
    walletconnect: {
      package: WalletConnectProvider.default,
      options: { rpc: {56: "https://bsc-dataseed.binance.org/"}, chainId:56 }
    }
  };
  web3Modal = new Web3Modal.default({ network:"binance", cacheProvider:false, providerOptions });
}

/* äº‹ä»¶ç»‘å®šï¼ˆè¯­è¨€æŒ‰é’®ç­‰ï¼‰ */
function bindUI(){
  document.getElementById('langBtn').addEventListener('click', ()=>{
    lang = lang === 'zh' ? 'en' : 'zh';
    document.getElementById('langBtn').innerText = lang === 'zh' ? 'ä¸­æ–‡' : 'EN';
  });
}

/* è¿æ¥é’±åŒ… */
async function connectWallet(){
  try{
    const instance = await web3Modal.connect();
    provider = new ethers.providers.Web3Provider(instance);
    signer = provider.getSigner();
    const address = await signer.getAddress();
    document.getElementById('wallet-address').innerText = address;

    tiContract = new ethers.Contract(TI_TOKEN_ADDRESS, [
      "function name() view returns(string)",
      "function symbol() view returns(string)",
      "function decimals() view returns(uint8)",
      "function totalSupply() view returns(uint256)",
      "function balanceOf(address) view returns(uint256)",
      "function approve(address,uint256)"
    ], signer);

    routerContract = new ethers.Contract(PANCAKE_ROUTER_ADDRESS, [
      "function getAmountsOut(uint amountIn,address[] calldata path) view returns(uint[] memory)",
      "function getAmountsIn(uint amountOut,address[] calldata path) view returns(uint[] memory)",
      "function swapExactETHForTokens(uint amountOutMin,address[] calldata path,address to,uint deadline) external payable returns(uint[] memory)",
      "function swapExactTokensForETH(uint amountIn,uint amountOutMin,address[] calldata path,address to,uint deadline) external returns(uint[] memory)"
    ], signer);

    await refreshBalances();
    fetchTxHistory();
    await refreshTokenInfo();
  }catch(e){ console.error("connectWallet failed", e); alert("é’±åŒ…è¿æ¥å¤±è´¥ï¼Œè¯·åœ¨æ§åˆ¶å°æŸ¥çœ‹é”™è¯¯"); }
}

/* åˆ·æ–°ä»£å¸ä¿¡æ¯ï¼ˆåç§°ã€ä»·æ ¼ã€ä¾›åº”ï¼‰ */
async function refreshTokenInfo(){
  // å°è¯•ç”¨ providerï¼ˆå¦‚æœæœ‰ï¼‰è¯»å–åˆçº¦ä¿¡æ¯ï¼Œå¦åˆ™åªå–ä»·æ ¼
  try{
    // ä½¿ç”¨å…¬å…± provider ä¸´æ—¶è¯»å–ï¼ˆä¸éœ€è¦ç”¨æˆ·è¿æ¥ï¼‰
    const tempProvider = new ethers.providers.JsonRpcProvider("https://bsc-dataseed.binance.org/");
    const tempContract = new ethers.Contract(TI_TOKEN_ADDRESS, ["function name() view returns(string)","function symbol() view returns(string)","function decimals() view returns(uint8)","function totalSupply() view returns(uint256)"], tempProvider);
    const [name, symbol, decimals, totalSupply] = await Promise.all([
      tempContract.name().catch(()=>''), tempContract.symbol().catch(()=>''), tempContract.decimals().catch(()=>18), tempContract.totalSupply().catch(()=>0)
    ]);
    if(name) document.getElementById('tokenName').innerText = name;
    if(symbol) document.getElementById('tokenSymbol').innerText = symbol;

    // ä½¿ç”¨ DexScreener è·å–ä»·æ ¼
    try{
      const res = await fetch(`https://api.dexscreener.com/latest/dex/pairs/bsc/${TI_TOKEN_ADDRESS}`);
      const js = await res.json();
      if(js && js.pairs && js.pairs[0]){
        const pair = js.pairs[0];
        document.getElementById('tokenPrice').innerText = parseFloat(pair.priceNative).toFixed(6) + ' BNB';
        document.getElementById('tokenPriceUSD').innerText = parseFloat(pair.priceUsd).toFixed(4);
        document.getElementById('poolInfo').innerText = `${pair.dexName} â€¢ ${pair.liquidity?.usd?('$'+Number(pair.liquidity.usd).toFixed(0)):'â€”'}`;
      }
    }catch(e){ console.warn('dexscreener fail', e); }
    if(typeof totalSupply !== 'undefined'){
      const formatted = ethers.utils.formatUnits(totalSupply, decimals);
      document.getElementById('tokenSupply').innerText = formatted;
    }
  }catch(e){ console.error('refreshTokenInfo err', e); }
}

/* åˆ·æ–°é’±åŒ…ä½™é¢ */
async function refreshBalances(){
  if(!provider || !signer) return;
  try{
    const address = await signer.getAddress();
    const balance = await provider.getBalance(address);
    const tBalance = await tiContract.balanceOf(address);
    document.getElementById('bnbBalance').innerText = ethers.utils.formatEther(balance);
    const decimals = await tiContract.decimals();
    document.getElementById('tiBalance').innerText = ethers.utils.formatUnits(tBalance, decimals);
  }catch(e){ console.error('refreshBalances', e); }
}

/* è·å–é“¾ä¸Šæœ€è¿‘äº¤æ˜“ï¼ˆBscScan å…¬å…±æ¥å£ï¼Œæ³¨æ„é™æµï¼‰ */
async function fetchTxHistory(){
  try{
    const addr = signer ? await signer.getAddress() : null;
    if(!addr){ document.getElementById('txList').innerHTML = '<div class="tiny">è¯·å…ˆè¿æ¥é’±åŒ…ä»¥æŸ¥çœ‹ä¸è¯¥åœ°å€ç›¸å…³çš„ Ti äº¤æ˜“</div>'; return; }
    document.getElementById('txList').innerHTML = '<div class="tiny">åŠ è½½ä¸­â€¦</div>';
    const url = `https://api.bscscan.com/api?module=account&action=tokentx&address=${addr}&contractaddress=${TI_TOKEN_ADDRESS}&page=1&offset=8&sort=desc`;
    const res = await fetch(url);
    const js = await res.json();
    if(js.status === "1" && js.result && js.result.length>0){
      const nodes = js.result.map(tx=>{
        const time = new Date(tx.timeStamp*1000).toLocaleString();
        const shortHash = tx.hash.slice(0,10) + '...';
        const side = tx.from.toLowerCase() === addr.toLowerCase() ? 'å–å‡º' : 'ä¹°å…¥';
        const amount = ethers.utils.formatUnits(tx.value, 18);
        return `<div style="padding:8px 0;border-bottom:1px dashed rgba(255,255,255,0.02)"><div style="display:flex;justify-content:space-between"><div><a class="tx-link" href="https://bscscan.com/tx/${tx.hash}" target="_blank">${shortHash}</a> â€¢ ${side}</div><div class="tiny">${time}</div></div><div class="tiny">æ•°é‡: ${amount} Ti</div></div>`;
      }).join('');
      document.getElementById('txList').innerHTML = nodes;
    } else {
      document.getElementById('txList').innerHTML = '<div class="tiny">æš‚æ— é“¾ä¸Šè®°å½•æˆ– BscScan é™æµ</div>';
    }
  }catch(e){ console.error('fetchTxHistory', e); document.getElementById('txList').innerHTML = '<div class="tiny">è·å–å¤±è´¥</div>'; }
}

/* è®¡ç®— Ti çš„ BNB éœ€æ±‚ */
async function calculateTiSwap(){
  const val = parseFloat(document.getElementById('tiAmount').value);
  if(!val || !routerContract){ alert('è¯·è¾“å…¥æ•°é‡å¹¶è¿æ¥é’±åŒ…'); return; }
  try{
    const decimals = await tiContract.decimals();
    const amountUnits = ethers.utils.parseUnits(val.toString(), decimals);
    const amountsIn = await routerContract.getAmountsIn(amountUnits, [WBNB_ADDRESS, TI_TOKEN_ADDRESS]);
    const need = ethers.utils.formatEther(amountsIn[0]);
    document.getElementById('tiCalcValue').innerText = need + ' BNB';
    return { need, amountUnits };
  }catch(e){ console.error(e); document.getElementById('tiCalcValue').innerText = 'è®¡ç®—å¤±è´¥'; }
}

/* è´­ä¹° Tiï¼ˆç¡®è®¤å‡½æ•°ï¼‰ */
async function confirmBuyTi(){
  if(!routerContract || !signer){ alert('è¯·å…ˆè¿æ¥é’±åŒ…'); return; }
  const val = parseFloat(document.getElementById('tiAmount').value);
  if(!val){ alert('è¯·è¾“å…¥ Ti æ•°é‡'); return; }
  // æ˜¾ç¤ºç¡®è®¤å¯¹è¯ï¼ˆç®€åŒ–ä¸º confirmï¼‰
  if(!confirm(`ç¡®è®¤è´­ä¹° ${val} Ti å—ï¼Ÿå°†åœ¨ PancakeSwap ä¸Šå®Œæˆäº¤æ˜“ã€‚`)) return;
  try{
    setTradeStatus('å‘é€äº¤æ˜“ä¸­...');
    const decimals = await tiContract.decimals();
    const amountUnits = ethers.utils.parseUnits(val.toString(), decimals);
    const amountsIn = await routerContract.getAmountsIn(amountUnits, [WBNB_ADDRESS, TI_TOKEN_ADDRESS]);
    const value = amountsIn[0];
    // å‘äº¤æ˜“
    const tx = await routerContract.swapExactETHForTokens(
      0,
      [WBNB_ADDRESS, TI_TOKEN_ADDRESS],
      await signer.getAddress(),
      Math.floor(Date.now()/1000) + 60*10,
      { value: value, gasLimit: 300000 }
    );
    setTradeTx(tx.hash);
    setTradeStatus('ç­‰å¾…ç¡®è®¤ï¼ˆé“¾ä¸Šï¼‰');
    await tx.wait();
    setTradeStatus('äº¤æ˜“å®Œæˆ');
    await refreshBalances();
    fetchTxHistory();
  }catch(e){ console.error(e); setTradeStatus('äº¤æ˜“å¤±è´¥'); alert('äº¤æ˜“å¤±è´¥ï¼Œè¯·æŸ¥çœ‹æ§åˆ¶å°'); }
}

/* å‡ºå”® Ti */
async function confirmSellTi(){
  if(!routerContract || !signer){ alert('è¯·å…ˆè¿æ¥é’±åŒ…'); return; }
  const val = parseFloat(document.getElementById('tiAmount').value);
  if(!val){ alert('è¯·è¾“å…¥ Ti æ•°é‡'); return; }
  if(!confirm(`ç¡®è®¤å‡ºå”® ${val} Ti å—ï¼Ÿ`)) return;
  try{
    setTradeStatus('æˆæƒä¸­...');
    const decimals = await tiContract.decimals();
    const amountUnits = ethers.utils.parseUnits(val.toString(), decimals);
    // approve
    const approveTx = await tiContract.approve(PANCAKE_ROUTER_ADDRESS, amountUnits);
    await approveTx.wait();
    setTradeStatus('æ‰§è¡Œå‡ºå”®...');
    const tx = await routerContract.swapExactTokensForETH(
      amountUnits,
      0,
      [TI_TOKEN_ADDRESS, WBNB_ADDRESS],
      await signer.getAddress(),
      Math.floor(Date.now()/1000) + 60*10,
      { gasLimit: 300000 }
    );
    setTradeTx(tx.hash);
    await tx.wait();
    setTradeStatus('å‡ºå”®å®Œæˆ');
    await refreshBalances();
    fetchTxHistory();
  }catch(e){ console.error(e); setTradeStatus('äº¤æ˜“å¤±è´¥'); alert('å‡ºå”®å¤±è´¥ï¼Œè¯·æŸ¥çœ‹æ§åˆ¶å°'); }
}

/* è®¡ç®—å…¶ä»–ä»£å¸éœ€æ±‚ */
async function calculateOtherSwap(){
  const addr = document.getElementById('otherTokenAddress').value.trim();
  const amt = parseFloat(document.getElementById('otherAmount').value);
  if(!addr||!amt){ alert('è¯·è¾“å…¥ä»£å¸åœ°å€ä¸æ•°é‡'); return; }
  try{
    const token = new ethers.Contract(addr, ["function decimals() view returns (uint8)"], provider || new ethers.providers.JsonRpcProvider("https://bsc-dataseed.binance.org/"));
    const dec = await token.decimals();
    const amountUnits = ethers.utils.parseUnits(amt.toString(), dec);
    const amountsIn = await routerContract.getAmountsIn(amountUnits, [WBNB_ADDRESS, addr]);
    document.getElementById('otherCalcValue').innerText = ethers.utils.formatEther(amountsIn[0]) + ' BNB';
  }catch(e){ console.error(e); document.getElementById('otherCalcValue').innerText = 'è®¡ç®—å¤±è´¥'; }
}

/* è´­ä¹°å…¶ä»–ä»£å¸ï¼ˆç¡®è®¤ï¼‰ */
async function confirmBuyOther(){
  const addr = document.getElementById('otherTokenAddress').value.trim();
  const amt = parseFloat(document.getElementById('otherAmount').value);
  if(!addr||!amt) { alert('è¯·è¾“å…¥ä»£å¸åœ°å€ä¸æ•°é‡'); return; }
  if(!confirm(`ç¡®è®¤è´­ä¹° ${amt} å•ä½çš„ä»£å¸ ${addr} å—ï¼Ÿ`)) return;
  try{
    setTradeStatus('å‘é€è´­ä¹°äº¤æ˜“...');
    const token = new ethers.Contract(addr, ["function decimals() view returns (uint8)"], provider || new ethers.providers.JsonRpcProvider("https://bsc-dataseed.binance.org/"));
    const dec = await token.decimals();
    const amountUnits = ethers.utils.parseUnits(amt.toString(), dec);
    const amountsIn = await routerContract.getAmountsIn(amountUnits, [WBNB_ADDRESS, addr]);
    const tx = await routerContract.swapExactETHForTokens(0, [WBNB_ADDRESS, addr], await signer.getAddress(), Math.floor(Date.now()/1000)+600, { value: amountsIn[0], gasLimit: 400000 });
    setTradeTx(tx.hash);
    await tx.wait();
    setTradeStatus('è´­ä¹°å®Œæˆ');
    fetchTxHistory();
    await refreshBalances();
  }catch(e){ console.error(e); setTradeStatus('å¤±è´¥'); alert('è´­ä¹°å¤±è´¥'); }
}

/* äº¤æ˜“çŠ¶æ€ UI å¸®åŠ©å‡½æ•° */
function setTradeStatus(txt){ document.getElementById('tradeStatus').innerText = txt; }
function setTradeTx(hash){
  document.getElementById('tradeTx').innerHTML = `<a href="https://bscscan.com/tx/${hash}" target="_blank" class="tx-link">${hash}</a>`;
}

/* mascot è¡Œä¸º */
const CHATTY = [
  "å˜»å˜»~æˆ‘å–œæ¬¢ Tiï¼",
  "åˆ«å¿˜äº†ç•™ä¸€ç‚¹ BNB åš Gas å“¦~",
  "æ»‘ç‚¹è®¾ç½®å¤ªé«˜ä¼šä¹°è´µï¼Œç¨³ä¸€ç‚¹~",
  "æ£€æµ‹åˆ°ä½ å¾ˆä¼˜ç§€ï¼Œç»§ç»­å»ºä»“å§ï¼",
  "æœºå™¨äººä¹Ÿè¦ä¸‹ç­äº†â€¦ï¼ˆå¼€ç©ç¬‘ï¼‰"
];
function initMascot(){
  const m = document.getElementById('mascot');
  const s = document.getElementById('mascotSpeech');
  const t = document.getElementById('speechText');
  m.addEventListener('click', ()=>{
    t.innerText = CHATTY[Math.floor(Math.random()*CHATTY.length)];
    s.style.display = 'block';
    // small sound (optional): use WebAudio short beep
    try{
      const ctx = new (window.AudioContext || window.webkitAudioContext)();
      const o = ctx.createOscillator(); const g = ctx.createGain();
      o.type='sine'; o.frequency.value = 600; g.gain.value = 0.02;
      o.connect(g); g.connect(ctx.destination);
      o.start(); setTimeout(()=>{ o.stop(); ctx.close(); }, 120);
    }catch(e){/* ignore */ }
  });
}
function hideSpeech(){ document.getElementById('mascotSpeech').style.display='none'; }

/* helper: ç®€å•ç¡®è®¤ wrapper (ç”¨äº UI äº¤äº’æ¼”ç¤º) */
function confirmBuyTiWrapper(){ /* not used */ }

/* å…¬å¼€åˆ·æ–°æ¥å£ */
window.refreshBalances = refreshBalances;
window.fetchTxHistory = fetchTxHistory;
window.connectWallet = connectWallet;
window.calculateTiSwap = calculateTiSwap;
window.calculateOtherSwap = calculateOtherSwap;
window.confirmBuyTi = confirmBuyTi;
window.confirmSellTi = confirmSellTi;
window.confirmBuyOther = confirmBuyOther;
window.toggleLanguage = function(){ lang = lang==='zh' ? 'en' : 'zh'; document.getElementById('langBtn').innerText = lang==='zh'?'ä¸­æ–‡':'EN'; };

</script>
</body>
</html>
