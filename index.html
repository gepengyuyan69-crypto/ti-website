<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>TI/USDT K-Line Chart</title>
  <!-- Chart.js core library -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Financial (candlestick) chart plugin -->
  <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-financial"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px; 
      background-color: #f5f5f5;
    }
    #container {
      max-width: 800px;
      margin: auto;
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    #timeframe-buttons button {
      margin-right: 10px;
      padding: 8px 16px;
      font-size: 14px;
      cursor: pointer;
      border: none;
      border-radius: 4px;
      background: #007bff;
      color: #fff;
    }
    #timeframe-buttons button.active {
      background: #0056b3;
    }
    canvas {
      margin-top: 20px;
    }
  </style>
</head>
<body>
<div id="container">
  <h2>TI/USDT Candlestick Chart</h2>
  <div id="timeframe-buttons">
    <button data-unit="minute" data-interval="1" class="active">1m</button>
    <button data-unit="minute" data-interval="5">5m</button>
    <button data-unit="minute" data-interval="15">15m</button>
    <!-- Add more buttons as needed -->
  </div>
  <canvas id="klineChart" width="800" height="400"></canvas>
</div>

<script>
// Contract addresses (BSC)
const TI_ADDRESS = '0x20d9bc1566c6a9b9796e83a95854c406c9763a4a';
const USDT_ADDRESS = '0x55d398326f99059ff775485246999027b3197955';

// Chart.js setup
const ctx = document.getElementById('klineChart').getContext('2d');
let chart;

// Store candles data here
let candles = [];

// Initialize chart with empty data
function createChart(unit, step) {
  if (chart) chart.destroy();
  chart = new Chart(ctx, {
    type: 'candlestick',
    data: {
      datasets: [{
        label: 'TI/USDT',
        data: candles
      }]
    },
    options: {
      responsive: true,
      animation: false,
      scales: {
        x: {
          type: 'time',
          time: {
            unit: unit,
            stepSize: step
          }
        },
        y: {
          position: 'right'
        }
      },
      plugins: {
        legend: { display: false }
      }
    }
  });
}

// Fetch latest price from DexScreener API and update candles
async function fetchAndUpdate() {
  try {
    const url = `https://api.dexscreener.com/tokens/v1/bsc/${TI_ADDRESS},${USDT_ADDRESS}`;
    const res = await fetch(url);
    const data = await res.json();
    if (!data || data.length === 0) return;
    // Find the TI/USDT pair in results
    const pair = data.find(p => 
      (p.baseToken.address.toLowerCase() === TI_ADDRESS.toLowerCase() &&
       p.quoteToken.address.toLowerCase() === USDT_ADDRESS.toLowerCase())
    );
    if (!pair) return;
    const price = parseFloat(pair.priceUsd); // Use USD price for chart

    const now = Date.now();
    const lastCandle = candles[candles.length - 1];
    const timeframe = currentInterval * 60 * 1000; // in ms

    if (!lastCandle || now - lastCandle.time >= timeframe) {
      // Start a new candle
      const openPrice = lastCandle ? lastCandle.close : price;
      candles.push({ time: now, open: openPrice, high: price, low: price, close: price });
    } else {
      // Update existing candle
      lastCandle.high = Math.max(lastCandle.high, price);
      lastCandle.low = Math.min(lastCandle.low, price);
      lastCandle.close = price;
    }
    chart.update();
  } catch (error) {
    console.error('Error fetching data:', error);
  }
}

// Handle timeframe button click
let currentUnit = 'minute', currentInterval = 1;
document.querySelectorAll('#timeframe-buttons button').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('#timeframe-buttons button').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    currentUnit = btn.getAttribute('data-unit');
    currentInterval = parseInt(btn.getAttribute('data-interval'));
    // Re-create chart with new time unit/step
    createChart(currentUnit, currentInterval);
  });
});

// Initial chart
createChart(currentUnit, currentInterval);

// Fetch initial data point and then update every 5 seconds
fetchAndUpdate();
setInterval(fetchAndUpdate, 5000);  // poll DexScreener API every 5 seconds

</script>
</body>
</html>
